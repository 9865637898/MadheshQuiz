<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>Madhesh Province Master Prep</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-secondary: #cbd5e1;
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --correct-color: #00e676;
            --wrong-color: #ff1744;
            --timer-color: #f472b6;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: #0f172a;
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                              radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                              radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            margin: 0; padding: 0; color: var(--text-main);
            min-height: 100vh; -webkit-tap-highlight-color: transparent;
        }

        /* --- IMMERSIVE LAYOUT --- */
        .screen {
            display: none; padding: 24px; max-width: 600px; margin: 0 auto;
            min-height: 100vh; box-sizing: border-box; flex-direction: column;
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .screen.active { display: flex; }
        
        #screen-home.active, #screen-result.active, #screen-login.active { justify-content: center; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- TYPOGRAPHY --- */
        h1 {
            font-size: 2.2rem; font-weight: 800; text-align: center;
            background: linear-gradient(to right, #4ade80, #2dd4bf);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 5px; line-height: 1.2; text-shadow: 0 10px 30px rgba(45, 212, 191, 0.3);
        }
        h2 { font-size: 1.8rem; text-align: center; margin-bottom: 20px; }
        p { color: var(--text-secondary); font-size: 1rem; line-height: 1.6; }

        /* --- GLASSMORPHISM CARDS --- */
        .glass-card {
            background: var(--glass-bg); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border); border-radius: 24px; padding: 30px 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36); margin-bottom: 20px;
        }

        /* --- INPUTS --- */
        input, select {
            width: 100%; padding: 18px; margin: 12px 0; background: rgba(0, 0, 0, 0.3);
            border: 2px solid var(--glass-border); border-radius: 16px; color: white;
            font-size: 1.1rem; font-family: 'Poppins', sans-serif; outline: none; transition: 0.3s; box-sizing: border-box;
        }
        input:focus, select:focus { border-color: #6366f1; background: rgba(0,0,0,0.5); }
        select option { background: #0f172a; }

        /* --- BUTTONS --- */
        .btn {
            width: 100%; padding: 20px; border: none; border-radius: 18px; font-size: 1.2rem; font-weight: 600;
            cursor: pointer; color: white; margin-bottom: 16px; position: relative; overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s; display: flex; align-items: center; justify-content: center; text-align: center;
        }
        .btn:active { transform: scale(0.96); }

        .btn-primary { background: var(--primary-gradient); box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4); }
        .btn-success { background: linear-gradient(135deg, #059669 0%, #34d399 100%); box-shadow: 0 4px 20px rgba(52, 211, 153, 0.4); }
        .btn-premium { background: linear-gradient(135deg, #d97706 0%, #fbbf24 100%); box-shadow: 0 4px 20px rgba(251, 191, 36, 0.4); }
        .btn-outline { background: transparent; border: 2px solid var(--glass-border); color: var(--text-secondary); }

        /* --- TOPIC GRID --- */
        .topic-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .topic-btn {
            background: rgba(0, 0, 0, 0.3); border: 1px solid var(--glass-border);
            padding: 16px 20px; border-radius: 16px; text-align: left; font-size: 1rem;
            color: white; display: flex; align-items: center; cursor: pointer; transition: 0.2s;
        }
        .topic-btn:hover { background: rgba(99, 102, 241, 0.2); border-color: #6366f1; }
        .topic-badge {
            background: var(--primary-gradient); color: white; font-size: 0.85rem; font-weight: 700;
            padding: 4px 10px; border-radius: 12px; margin-right: 15px; flex-shrink: 0;
        }

        /* --- QUIZ INTERFACE --- */
        .top-compliment { text-align: center; height: 40px; font-size: 1.4rem; font-weight: 700; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); transition: all 0.3s; }
        .quiz-meta { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; font-size: 1rem; color: var(--text-secondary); font-weight: 500; }
        .timer { color: var(--timer-color); font-weight: 700; font-size: 1.4rem; }
        
        .question-text { font-size: 1.35rem; font-weight: 600; line-height: 1.5; margin-bottom: 30px; }
        
        .option-btn {
            background: rgba(255,255,255,0.03); border: 1px solid var(--glass-border);
            padding: 20px; border-radius: 16px; margin-bottom: 14px; font-size: 1.1rem;
            text-align: left; display: flex; align-items: center; transition: 0.2s; cursor: pointer;
        }
        .option-circle {
            width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.1);
            display: flex; justify-content: center; align-items: center;
            margin-right: 15px; font-size: 0.9rem; font-weight: 700; flex-shrink: 0;
        }

        .option-btn.correct { background: rgba(0, 230, 118, 0.2); border-color: var(--correct-color); }
        .option-btn.correct .option-circle { background: var(--correct-color); color: black; }
        .option-btn.wrong { background: rgba(255, 23, 68, 0.2); border-color: var(--wrong-color); }
        .option-btn.wrong .option-circle { background: var(--wrong-color); color: white; }

        .explanation-box { margin-top: 20px; background: rgba(99, 102, 241, 0.15); border-left: 4px solid #6366f1; padding: 20px; border-radius: 12px; font-size: 1rem; line-height: 1.6; display: none; animation: fadeIn 0.3s; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .spinner { width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 10px; display: inline-block; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="screen-home" class="screen active">
        <h1>Madhesh Province</h1>
        <p style="text-align:center; margin-bottom: 30px;">Exam Master Pro</p>
        
        <div class="glass-card">
            <h3 style="text-align:center; margin-top:0; color:var(--text-secondary)">Candidate Login</h3>
            
            <input type="text" id="input-name" placeholder="Enter Your Name">
            <select id="input-qual">
                <option value="" disabled selected>Select Qualification</option>
                <option value="Engineer">Engineer</option>
                <option value="Sub Engineer">Sub Engineer</option>
                <option value="Assistant Sub Engineer">Asst. Sub Engineer</option>
            </select>
            <button class="btn btn-primary" onclick="app.saveUser()">Enter Dashboard ‚ûî</button>
        </div>
    </div>

    <div id="screen-dash" class="screen">
        <h2 id="user-greeting" style="margin-top: 0; color: #4ade80;">Hello, Candidate!</h2>
        <p style="text-align: center; margin-bottom: 25px;">Select a topic to start practicing.</p>
        
        <div id="topics-container" class="topic-grid">
            </div>
    </div>

    <div id="screen-topic-detail" class="screen">
        <h2 id="detail-topic-title" style="font-size: 1.5rem; color: #2dd4bf; margin-top: 0;">Topic Title</h2>
        
        <div class="glass-card">
            <h3 style="text-align: center; margin-top: 0;">Choose Practice Set</h3>
            <p style="text-align: center; margin-bottom: 25px; color: var(--text-secondary);">Set A contains the first 20 questions.</p>
            
            <button class="btn btn-success" onclick="app.loadSet('A')">
                Set A - Free Preview (20 MCQs)
            </button>
            
            <button id="btn-set-b" class="btn btn-premium" onclick="app.loadSet('B')">
                Set B - Premium MCQs üîê
            </button>

            <button class="btn btn-outline" style="margin-top: 10px;" onclick="app.showScreen('screen-dash')">‚Üê Back to Dashboard</button>
        </div>
    </div>

    <div id="screen-login" class="screen">
        <div class="glass-card" style="text-align:center;">
            <h2>Premium Access üîê</h2>
            <p style="margin-bottom:25px;">Enter your unique code to unlock all Set B topics permanently.</p>
            
            <input type="text" id="premium-code" placeholder="Enter Code Here" style="text-align:center; font-size:1.4rem; letter-spacing:2px; text-transform: uppercase;">
            
            <button class="btn btn-primary" id="btn-verify" onclick="app.verifyCode()">
                Verify & Unlock
            </button>
            
            <button class="btn" style="background:#25D366; margin-top: 15px;" onclick="app.openWhatsApp()">
                Get Code on WhatsApp
            </button>
            <button class="btn btn-outline" style="margin-top: 10px;" onclick="app.showScreen('screen-topic-detail')">Cancel</button>
        </div>
    </div>

    <div id="screen-quiz" class="screen">
        
        <div id="feedback-top" class="top-compliment"></div>

        <div class="glass-card">
            <div class="quiz-meta">
                <span id="quiz-progress" style="background:rgba(255,255,255,0.1); padding:5px 15px; border-radius:20px;">1 / 20</span>
                <span id="quiz-score" style="color: #4ade80; font-weight: 700;">Score: 0</span>
            </div>
            
            <div id="question-text" class="question-text">Loading...</div>
            
            <div id="options-container"></div>
        </div>

        <div id="explanation-box" class="explanation-box"></div>

        <div id="next-btn-container" class="hidden" style="margin-top:20px;">
            <button class="btn btn-primary" id="btn-next" onclick="app.nextQuestion()">Next Question ‚û°</button>
        </div>
        
        <button class="btn btn-outline" style="margin-top: 20px; border: none;" onclick="app.showScreen('screen-topic-detail')">Quit Exam</button>
    </div>

    <div id="screen-result" class="screen">
        <div class="glass-card" style="text-align:center; margin-top: 40px;">
            <h2 id="result-name">Quiz Completed!</h2>
            <div style="font-size:5rem; font-weight:800; color:#4ade80; text-shadow:0 0 30px rgba(74, 222, 128, 0.4); margin:20px 0;" id="final-score">0%</div>
            
            <p id="result-accuracy" style="font-size: 1.1rem; color: var(--text-secondary);">You attempted 0 questions.</p>
            <p id="result-msg" style="font-size:1.2rem; margin-bottom:30px; font-weight: 600;">Result message</p>
            
            <button class="btn btn-primary" style="margin-top:30px;" onclick="app.showScreen('screen-dash')">Return to Dashboard</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbw4EBwp_tSyWgTnNsdBNnCNRa0Nzj1bAjjCuG2SaffMU1_wHuIFpieOouOb0Zl5KjpsrA/exec"; 
        const WHATSAPP_URL = "https://wa.me/qr/O7FO3PRTOUFGO1";

        const allTopics = [
        { id: "1.1", title: "‡§Æ‡§ß‡•á‡§∂ ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§≠‡§æ‡§ó ‡•ß" },
        { id: "1.2", title: "‡§Æ‡§ß‡•á‡§∂ ‡§µ‡§ø‡§∂‡•á‡§∑ ‡§≠‡§æ‡§ó ‡•® " },
            { id: "1.3", title: "‡§Æ‡§ß‡•á‡§∂ ‡§™‡•ç‡§∞‡§¶‡•á‡§∂‡§ï‡•ã ‡§≠‡•å‡§ó‡•ã‡§≤‡§ø‡§ï ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ, ‡§™‡•ç‡§∞‡§æ‡§ï‡•É‡§§‡§ø‡§ï ‡§∏‡•ç‡§∞‡•ã‡§§, ‡§∏‡§æ‡§ß‡§® ‡§∞ ‡§∏‡§Æ‡•ç‡§≠‡§æ‡§µ‡§®‡§æ‡§π‡§∞‡•Å" },
            { id: "1.4", title: "‡§Æ‡§ß‡•á‡§∂ ‡§™‡•ç‡§∞‡§¶‡•á‡§∂‡§ï‡•ã ‡§ê‡§§‡§ø‡§π‡§æ‡§∏‡§ø‡§ï, ‡§∏‡§æ‡§Ç‡§∏‡•ç‡§ï‡•É‡§§‡§ø‡§ï ‡§∞ ‡§∏‡§æ‡§Æ‡§æ‡§ú‡§ø‡§ï ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä" },
            { id: "1.5", title: "‡§Æ‡§ß‡•á‡§∂ ‡§™‡•ç‡§∞‡§¶‡•á‡§∂‡§ï‡•ã ‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§Ö‡§µ‡§∏‡•ç‡§•‡§æ ‡§∞ ‡§ö‡§æ‡§≤‡•Å ‡§Ü‡§µ‡§ß‡§ø‡§ï ‡§Ø‡•ã‡§ú‡§®‡§æ ‡§∏‡§Æ‡•ç‡§¨‡§®‡•ç‡§ß‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä" },
            { id: "1.6", title: "‡§™‡•ç‡§∞‡§¶‡•á‡§∂ ‡§®‡§ø‡§ú‡§æ‡§Æ‡§§‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§ê‡§®, ‡•®‡•¶‡•≠‡•≠" },
            { id: "1.7", title: "‡§™‡•ç‡§∞‡§¶‡•á‡§∂ ‡§®‡§ø‡§ú‡§æ‡§Æ‡§§‡•Ä ‡§∏‡•á‡§µ‡§æ ‡§®‡§ø‡§Ø‡§Æ‡§æ‡§µ‡§≤‡•Ä, ‡•®‡•¶‡•≠‡•Ø" },
            { id: "1.8", title: "‡§Æ‡§ß‡•á‡§∂ ‡§™‡•ç‡§∞‡§¶‡•á‡§∂ ‡§ú‡§ø‡§≤‡•ç‡§≤‡§æ ‡§µ‡§ø‡§∂‡§ø‡§∑‡•ç‡§ü ‡§§‡§•‡•ç‡§Ø‡§æ‡§ô‡•ç‡§ï ‡§∞ ‡§§‡§•‡•ç‡§Ø‡§π‡§∞‡•Ç" },
            { id: "2.3", title: "‡§™‡•ç‡§∞‡§¶‡•á‡§∂ ‡§≤‡•ã‡§ï ‡§∏‡•á‡§µ‡§æ ‡§Ü‡§Ø‡•ã‡§ó ‡§ê‡§®, ‡•®‡•¶‡•≠‡•¨ ‡§§‡§•‡§æ ‡§®‡§ø‡§Ø‡§Æ‡§æ‡§µ‡§≤‡•Ä, ‡•®‡•¶‡•≠‡•Æ" },
            { id: "2.4", title: "‡§∏‡•ç‡§•‡§æ‡§®‡•Ä‡§Ø ‡§∏‡§∞‡§ï‡§æ‡§∞ ‡§∏‡§û‡•ç‡§ö‡§æ‡§≤‡§® ‡§ê‡§®, ‡•®‡•¶‡•≠‡•™" },
            { id: "2.6", title: "‡§∏‡§æ‡§∞‡•ç‡§µ‡§ú‡§®‡§ø‡§ï ‡§ñ‡§∞‡§ø‡§¶ ‡§ê‡§®, ‡•®‡•¶‡•¨‡•© ‡§∞ ‡§®‡§ø‡§Ø‡§Æ‡§æ‡§µ‡§≤‡•Ä, ‡•®‡•¶‡•¨‡•™" },
            { id: "2.7", title: "‡§∏‡•Å‡§∂‡§æ‡§∏‡§® (‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§® ‡§§‡§•‡§æ ‡§∏‡§û‡•ç‡§ö‡§æ‡§≤‡§®) ‡§ê‡§®, ‡•®‡•¶‡•¨‡•™ ‡§∞ ‡§®‡§ø‡§Ø‡§Æ‡§æ‡§µ‡§≤‡•Ä, ‡•®‡•¶‡•¨‡•´" },
            { id: "2.8", title: "‡§Ü‡§∞‡•ç‡§•‡§ø‡§ï ‡§ï‡§æ‡§∞‡•ç‡§Ø‡§µ‡§ø‡§ß‡§ø ‡§§‡§•‡§æ ‡§µ‡§ø‡§§‡•ç‡§§‡•Ä‡§Ø ‡§â‡§§‡•ç‡§§‡§∞‡§¶‡§æ‡§Ø‡§ø‡§§‡•ç‡§µ ‡§ê‡§®, ‡•®‡•¶‡•≠‡•¨ ‡§∞ ‡§®‡§ø‡§Ø‡§Æ‡§æ‡§µ‡§≤‡•Ä, ‡•®‡•¶‡•≠‡•≠" },
            { id: "2.9", title: "‡§Æ‡§ß‡•á‡§∂ ‡§™‡•ç‡§∞‡§¶‡•á‡§∂ ‡§∏‡§∞‡§ï‡§æ‡§∞ ‡§Ö‡§®‡•ç‡§§‡§∞‡•ç‡§ó‡§§‡§ï‡§æ ‡§Æ‡§®‡•ç‡§§‡•ç‡§∞‡§æ‡§≤‡§Ø" }
        ];

        // --- APP LOGIC ---
        const app = {
            state: {
                user: { name: "", qual: "" },
                isPremium: false,
                currentTopicId: null,
                quizSet: [],
                currentIndex: 0,
                score: 0
            },

            init: function() {
                // Using new isolated storage keys for this specific app
                const savedUser = localStorage.getItem('madesh_pro_user');
                const savedPremium = localStorage.getItem('madesh_pro_premium');

                if (savedPremium === 'true') this.state.isPremium = true;

                if (savedUser) {
                    this.state.user = JSON.parse(savedUser);
                    this.buildDashboard();
                    this.showScreen('screen-dash');
                }
            },

            showScreen: function(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                window.scrollTo(0,0);
            },

            saveUser: function() {
                const name = document.getElementById('input-name').value.trim();
                const qual = document.getElementById('input-qual').value;
                if(!name || !qual) return alert("Please enter Name and Qualification");
                
                this.state.user = { name, qual };
                localStorage.setItem('madesh_pro_user', JSON.stringify(this.state.user));
                this.buildDashboard();
                this.showScreen('screen-dash');
            },

            buildDashboard: function() {
                document.getElementById('user-greeting').innerText = `Hello, ${this.state.user.name.split(" ")[0]}!`;
                const container = document.getElementById('topics-container');
                container.innerHTML = "";

                allTopics.forEach(topic => {
                    const btn = document.createElement('div');
                    btn.className = 'topic-btn';
                    btn.innerHTML = `<span class="topic-badge">${topic.id}</span> <span>${topic.title}</span>`;
                    btn.onclick = () => this.openTopic(topic);
                    container.appendChild(btn);
                });
            },

            openTopic: function(topic) {
                this.state.currentTopicId = topic.id;
                document.getElementById('detail-topic-title').innerText = `${topic.id}: ${topic.title}`;
                
                const btnB = document.getElementById('btn-set-b');
                if (this.state.isPremium) {
                    btnB.innerText = "Set B - Unlocked ‚úîÔ∏è";
                    btnB.classList.replace('btn-premium', 'btn-primary');
                } else {
                    btnB.innerText = "Set B - Premium MCQs üîê";
                    btnB.classList.replace('btn-primary', 'btn-premium');
                }

                this.showScreen('screen-topic-detail');
            },

            loadSet: async function(setType) {
                if (setType === 'B' && !this.state.isPremium) {
                    this.showScreen('screen-login');
                    return;
                }

                try {
                    // Fetches from the 'json' folder on your GitHub
                    const response = await fetch(`json/${this.state.currentTopicId}.json`);
                    if (!response.ok) {
                        alert(`File json/${this.state.currentTopicId}.json not found. Please upload it to your repository.`);
                        return;
                    }
                    const data = await response.json();
                    
                    if (setType === 'A') {
                        this.state.quizSet = data.slice(0, 20); // First 20 questions
                    } else {
                        this.state.quizSet = data.slice(20); // Question 21 onwards
                        if(this.state.quizSet.length === 0) return alert("No additional questions available for Set B yet.");
                    }
                    
                    this.startQuiz();
                } catch (error) {
                    alert("JSON parsing error. Ensure the file format is correct.");
                    console.error(error);
                }
            },
            startQuiz: function() {√π
                this.state.currentIndex = 0;
                this.state.score = 0;
                this.showScreen('screen-quiz');
                this.renderQuestion();
            },

            renderQuestion: function() {
                const q = this.state.quizSet[this.state.currentIndex];
                document.getElementById('quiz-progress').innerText = `${this.state.currentIndex + 1} / ${this.state.quizSet.length}`;
                document.getElementById('quiz-score').innerText = `Score: ${this.state.score}`;
                document.getElementById('question-text').innerText = q.q;

                const optsDiv = document.getElementById('options-container');
                optsDiv.innerHTML = "";
                
                document.getElementById('feedback-top').innerText = "";
                document.getElementById('explanation-box').style.display = 'none';
                document.getElementById('next-btn-container').classList.add('hidden');

                const letters = ['A', 'B', 'C', 'D'];

                q.o.forEach((opt, index) => {
                    const btn = document.createElement('div');
                    btn.className = 'option-btn';
                    btn.innerHTML = `<div class="option-circle">${letters[index]}</div> ${opt}`;
                    btn.onclick = () => this.handleAnswer(index, btn);
                    optsDiv.appendChild(btn);
                });
            },

            handleAnswer: function(selectedIndex, btnElement) {
                const allBtns = document.querySelectorAll('.option-btn');
                allBtns.forEach(b => b.style.pointerEvents = 'none');

                const q = this.state.quizSet[this.state.currentIndex];
                const isCorrect = selectedIndex === q.a;
                const feedbackTop = document.getElementById('feedback-top');
                const firstName = this.state.user.name.split(" ")[0];

                if (isCorrect) {
                    btnElement.classList.add('correct');
                    this.state.score++;
                    
                    const praises = ["Excellent", "Great Job", "Wonderful", "Amazing", "Correct"];
                    feedbackTop.style.color = "#4ade80";
                    feedbackTop.innerText = `${praises[Math.floor(Math.random() * praises.length)]}, ${firstName}! üåü`;
                } else {
                    btnElement.classList.add('wrong');
                    allBtns[q.a].classList.add('correct');
                    
                    feedbackTop.style.color = "#f43f5e";
                    feedbackTop.innerText = `Keep Learning, ${firstName}!`;
                }

                document.getElementById('quiz-score').innerText = `Score: ${this.state.score}`;
                document.getElementById('next-btn-container').classList.remove('hidden');
                
                const expBox = document.getElementById('explanation-box');
                if(q.e) {
                    expBox.innerText = `Explanation: ${q.e}`;
                    expBox.style.display = 'block';
                }

                if (this.state.currentIndex === this.state.quizSet.length - 1) {
                    document.getElementById('btn-next').innerText = "Finish Exam";
                } else {
                    document.getElementById('btn-next').innerText = "Next Question ‚û°";
                }
            },

            nextQuestion: function() {
                this.state.currentIndex++;
                if (this.state.currentIndex < this.state.quizSet.length) {
                    this.renderQuestion();
                } else {
                    this.showResults();
                }
            },

            showResults: function() {
                this.showScreen('screen-result');
                
                const total = this.state.quizSet.length;
                const percentage = Math.round((this.state.score / total) * 100);
                
                document.getElementById('result-name').innerText = `Completed, ${this.state.user.name.split(" ")[0]}!`;
                document.getElementById('final-score').innerText = `${percentage}%`;
                
                document.getElementById('result-accuracy').innerText = `You attempted ${total} questions and got ${this.state.score} correct.`;
                
                let msg = "";
                const msgEl = document.getElementById('result-msg');
                if (percentage >= 80) { msg = "Outstanding Preparation! üåü"; msgEl.style.color = "#4ade80"; }
                else if (percentage >= 50) { msg = "Good Effort, keep reviewing! üìö"; msgEl.style.color = "#fbbf24"; }
                else { msg = "Needs more practice! üí™"; msgEl.style.color = "#f43f5e"; }
                msgEl.innerText = msg;
            },

            openWhatsApp: function() {
                const msg = `Hello! I am ${this.state.user.name} (${this.state.user.qual}). I want to unlock Set B for Madhesh Province MCQs.`;
                window.open(`${WHATSAPP_URL}?text=${encodeURIComponent(msg)}`, '_blank');
            },

            verifyCode: function() {
                const codeInput = document.getElementById('premium-code');
                const code = codeInput.value.trim();
                const btn = document.getElementById('btn-verify');
                
                if (!code) return alert("Please enter a code");

                const originalText = btn.innerHTML;
                btn.innerHTML = 'Verifying <div class="spinner"></div>';
                btn.style.pointerEvents = 'none';

                fetch(`${WEB_APP_URL}?code=${code}&name=${this.state.user.name}&qual=${this.state.user.qual}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert("Code Verified! Premium Access Granted.");
                            this.state.isPremium = true;
                            localStorage.setItem('madesh_pro_premium', 'true');
                            codeInput.value = "";
                            this.showScreen('screen-topic-detail');
                            this.openTopic({ id: this.state.currentTopicId, title: document.getElementById('detail-topic-title').innerText.split(': ')[1] });
                        } else {
                            alert(data.message || "Invalid Code");
                        }
                    })
                    .catch(err => {
                        console.error(err);
                        alert("Network Error. Please try again.");
                    })
                    .finally(() => {
                        btn.innerHTML = originalText;
                        btn.style.pointerEvents = 'auto';
                    });
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>


